{% extends "base.html" %}

{% block extra_css %}
<style>
    .analytics-card {
        height: 100%;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
    }
    .stat-label {
        color: #94a3b8;
        font-size: 0.875rem;
    }
    .leaderboard-rank {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.875rem;
    }
    .rank-1 { background: linear-gradient(135deg, #ffd700, #ffb800); color: #000; }
    .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
    .rank-3 { background: linear-gradient(135deg, #cd7f32, #b06c2a); color: #fff; }
    .rank-other { background: #334155; color: #94a3b8; }
    .component-bar {
        height: 24px;
        background: #334155;
        border-radius: 4px;
        overflow: hidden;
    }
    .component-fill {
        height: 100%;
        display: flex;
        align-items: center;
        padding-left: 8px;
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Page Header -->
    <div class="col-12">
        <h4 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Score Analytics</h4>
        <p class="text-muted mb-0">Understand what drives high exploitability scores</p>
    </div>

    <!-- Summary Stats -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Score Distribution Summary</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadSummary()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body" id="summary-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Score Components Analysis -->
    <div class="col-lg-6">
        <div class="card analytics-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Score Component Analysis</h5>
            </div>
            <div class="card-body p-0" id="components-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Volume Penalty Effectiveness -->
    <div class="col-lg-6">
        <div class="card analytics-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-speedometer me-2"></i>Volume Penalty Effectiveness</h5>
            </div>
            <div class="card-body p-0" id="volume-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Competition Leaderboard -->
    <div class="col-lg-8">
        <div class="card analytics-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Competition Leaderboard</h5>
                <span class="badge bg-info">Learned from Data</span>
            </div>
            <div class="card-body p-0" id="leaderboard-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Bucket Analysis -->
    <div class="col-lg-4">
        <div class="card analytics-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock me-2"></i>Time Bucket Analysis</h5>
            </div>
            <div class="card-body p-0" id="time-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Odds Band Analysis -->
    <div class="col-lg-6">
        <div class="card analytics-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-percent me-2"></i>Odds Band Analysis</h5>
            </div>
            <div class="card-body p-0" id="odds-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Metrics by Score Band -->
    <div class="col-lg-6">
        <div class="card analytics-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-rulers me-2"></i>Raw Metrics by Score Band</h5>
            </div>
            <div class="card-body p-0" id="metrics-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- High Scoring Markets -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-star-fill text-warning me-2"></i>High Scoring Markets (55+)</h5>
                <span class="badge bg-success" id="high-score-count">Loading...</span>
            </div>
            <div class="card-body p-0" id="high-scores-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Movers Summary -->
    <div class="col-lg-6">
        <div class="card analytics-card border-success">
            <div class="card-header d-flex justify-content-between align-items-center bg-success bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-arrow-up-circle text-success me-2"></i>Top Steamers</h5>
                <a href="/movers" class="btn btn-sm btn-outline-success">View All</a>
            </div>
            <div class="card-body p-0" id="steamers-summary-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-success" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card analytics-card border-danger">
            <div class="card-header d-flex justify-content-between align-items-center bg-danger bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-arrow-down-circle text-danger me-2"></i>Top Drifters</h5>
                <a href="/movers" class="btn btn-sm btn-outline-danger">View All</a>
            </div>
            <div class="card-body p-0" id="drifters-summary-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-danger" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 2 Readiness Dashboard -->
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header d-flex justify-content-between align-items-center bg-warning bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-rocket-takeoff me-2"></i>Phase 2 Readiness</h5>
                <span class="badge bg-warning text-dark" id="readiness-badge">Checking...</span>
            </div>
            <div class="card-body" id="phase2-readiness-container">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Niche Performance -->
    <div class="col-lg-7">
        <div class="card analytics-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bullseye me-2"></i>Top Niches</h5>
                <small class="text-muted">Competition + Market Type</small>
            </div>
            <div class="card-body p-0" id="niche-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CLV Analysis -->
    <div class="col-lg-5">
        <div class="card analytics-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>CLV Analysis</h5>
                <small class="text-muted">By Score Band</small>
            </div>
            <div class="card-body p-0" id="clv-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Closing Data Capture (Phase 1 Validation) -->
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header d-flex justify-content-between align-items-center bg-info bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>Closing Data Capture</h5>
                <span class="badge bg-info">Phase 1 Validation</span>
            </div>
            <div class="card-body" id="closing-summary-container">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settled High-Score Markets -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-check2-circle me-2"></i>Settled High-Score Markets</h5>
                <span class="badge bg-secondary" id="settled-count">Loading...</span>
            </div>
            <div class="card-body p-0" id="closing-data-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load all analytics on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSummary();
        loadComponents();
        loadVolume();
        loadLeaderboard();
        loadTimeBuckets();
        loadOddsBands();
        loadRawMetrics();
        loadHighScores();
        loadSteamersSummary();
        loadDriftersSummary();
        loadPhase2Readiness();
        loadNichePerformance();
        loadCLVAnalysis();
        loadClosingSummary();
        loadClosingData();
    });

    // Summary Stats
    async function loadSummary() {
        try {
            const response = await fetch('/api/analytics/summary');
            const data = await response.json();

            const total = data.total_markets;
            const excellentPct = total ? (data.excellent_70_plus / total * 100).toFixed(1) : 0;
            const highPct = total ? (data.high_55_70 / total * 100).toFixed(1) : 0;
            const mediumPct = total ? (data.medium_40_55 / total * 100).toFixed(1) : 0;
            const lowPct = total ? (data.low_under_40 / total * 100).toFixed(1) : 0;

            document.getElementById('summary-container').innerHTML = `
                <div class="row g-4 text-center">
                    <div class="col-md-2">
                        <div class="stat-number text-info">${data.total_markets.toLocaleString()}</div>
                        <div class="stat-label">Total Scored</div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number text-success">${data.excellent_70_plus}</div>
                        <div class="stat-label">Excellent (70+)</div>
                        <small class="text-muted">${excellentPct}%</small>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number text-primary">${data.high_55_70}</div>
                        <div class="stat-label">High (55-70)</div>
                        <small class="text-muted">${highPct}%</small>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number text-warning">${data.medium_40_55}</div>
                        <div class="stat-label">Medium (40-55)</div>
                        <small class="text-muted">${mediumPct}%</small>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number text-danger">${data.low_under_40.toLocaleString()}</div>
                        <div class="stat-label">Low (<40)</div>
                        <small class="text-muted">${lowPct}%</small>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number" style="color: #22c55e;">${data.highest_score.toFixed(1)}</div>
                        <div class="stat-label">Highest Score</div>
                        <small class="text-muted">Avg: ${data.overall_avg_score.toFixed(1)}</small>
                    </div>
                </div>
            `;
        } catch (e) {
            document.getElementById('summary-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load summary</div>';
        }
    }

    // Score Components
    async function loadComponents() {
        try {
            const response = await fetch('/api/analytics/score-components');
            const data = await response.json();

            let html = '<table class="table table-sm mb-0"><thead><tr>' +
                '<th>Band</th><th>Count</th><th>Spread</th><th>Volatility</th><th>Update</th><th>Depth</th><th>Vol Penalty</th></tr></thead><tbody>';

            for (const row of data) {
                const bandClass = row.band.includes('Excellent') ? 'text-success' :
                                  row.band.includes('High') ? 'text-primary' :
                                  row.band.includes('Medium') ? 'text-warning' : 'text-danger';
                html += `
                    <tr>
                        <td><span class="${bandClass}">${row.band}</span></td>
                        <td>${row.count.toLocaleString()}</td>
                        <td>${row.avg_spread_score.toFixed(1)}</td>
                        <td>${row.avg_volatility_score.toFixed(1)}</td>
                        <td>${row.avg_update_score.toFixed(1)}</td>
                        <td>${row.avg_depth_score.toFixed(1)}</td>
                        <td class="text-danger">-${row.avg_volume_penalty.toFixed(1)}</td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            document.getElementById('components-container').innerHTML = html;
        } catch (e) {
            document.getElementById('components-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load components</div>';
        }
    }

    // Volume Analysis
    async function loadVolume() {
        try {
            const response = await fetch('/api/analytics/volume-analysis');
            const data = await response.json();

            let html = '<table class="table table-sm mb-0"><thead><tr>' +
                '<th>Volume Band</th><th>Markets</th><th>Avg Score</th><th>Avg Penalty</th><th>High Value</th></tr></thead><tbody>';

            for (const row of data) {
                const scoreClass = row.avg_score >= 55 ? 'text-success' : row.avg_score >= 40 ? 'text-warning' : 'text-danger';
                html += `
                    <tr>
                        <td>${row.band}</td>
                        <td>${row.market_count.toLocaleString()}</td>
                        <td class="${scoreClass}">${row.avg_score.toFixed(1)}</td>
                        <td class="text-danger">-${row.avg_volume_penalty.toFixed(1)}</td>
                        <td>${row.high_value}</td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            html += '<div class="px-3 py-2 small text-muted bg-dark"><i class="bi bi-info-circle me-1"></i>Low volume = higher scores (as expected). Volume penalty working correctly.</div>';
            document.getElementById('volume-container').innerHTML = html;
        } catch (e) {
            document.getElementById('volume-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load volume analysis</div>';
        }
    }

    // Competition Leaderboard
    async function loadLeaderboard() {
        try {
            const response = await fetch('/api/analytics/competition-leaderboard?limit=15');
            const data = await response.json();

            let html = '<table class="table table-sm table-hover mb-0"><thead><tr>' +
                '<th width="40">#</th><th>Competition</th><th>Markets</th><th>Avg Score</th><th>Max</th><th>High Value</th></tr></thead><tbody>';

            data.forEach((row, idx) => {
                const rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : 'rank-other';
                const scoreClass = row.avg_score >= 55 ? 'text-success' : row.avg_score >= 40 ? 'text-warning' : 'text-secondary';
                const country = row.country_code ? `<small class="text-muted ms-1">(${row.country_code})</small>` : '';

                html += `
                    <tr>
                        <td><span class="leaderboard-rank ${rankClass}">${idx + 1}</span></td>
                        <td><strong>${row.name}</strong>${country}</td>
                        <td>${row.markets_scored}</td>
                        <td class="${scoreClass} fw-bold">${row.avg_score.toFixed(1)}</td>
                        <td>${row.max_score.toFixed(1)}</td>
                        <td><span class="badge bg-success">${row.high_value_markets}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('leaderboard-container').innerHTML = html;
        } catch (e) {
            document.getElementById('leaderboard-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load leaderboard</div>';
        }
    }

    // Time Buckets
    async function loadTimeBuckets() {
        try {
            const response = await fetch('/api/analytics/time-buckets');
            const data = await response.json();

            let html = '<table class="table table-sm mb-0"><thead><tr>' +
                '<th>Bucket</th><th>Total</th><th>Avg</th><th>% High</th></tr></thead><tbody>';

            for (const row of data) {
                const pctClass = row.pct_high_value >= 1 ? 'text-success' : row.pct_high_value >= 0.5 ? 'text-warning' : 'text-secondary';
                html += `
                    <tr>
                        <td><span class="badge bg-secondary">${row.bucket}</span></td>
                        <td>${row.total_scores.toLocaleString()}</td>
                        <td>${row.avg_score.toFixed(1)}</td>
                        <td class="${pctClass}">${row.pct_high_value.toFixed(2)}%</td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            document.getElementById('time-container').innerHTML = html;
        } catch (e) {
            document.getElementById('time-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load time buckets</div>';
        }
    }

    // Odds Bands
    async function loadOddsBands() {
        try {
            const response = await fetch('/api/analytics/odds-bands');
            const data = await response.json();

            let html = '<table class="table table-sm mb-0"><thead><tr>' +
                '<th>Odds Band</th><th>Total</th><th>Avg Score</th><th>Max</th><th>% High</th></tr></thead><tbody>';

            for (const row of data) {
                const scoreClass = row.avg_score >= 40 ? 'text-success' : row.avg_score >= 30 ? 'text-warning' : 'text-secondary';
                html += `
                    <tr>
                        <td>${row.band}</td>
                        <td>${row.total_scores.toLocaleString()}</td>
                        <td class="${scoreClass}">${row.avg_score.toFixed(1)}</td>
                        <td>${row.max_score.toFixed(1)}</td>
                        <td>${row.pct_high_value.toFixed(2)}%</td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            document.getElementById('odds-container').innerHTML = html;
        } catch (e) {
            document.getElementById('odds-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load odds bands</div>';
        }
    }

    // Raw Metrics
    async function loadRawMetrics() {
        try {
            const response = await fetch('/api/analytics/raw-metrics');
            const data = await response.json();

            let html = '<table class="table table-sm mb-0"><thead><tr>' +
                '<th>Band</th><th>Spread (ticks)</th><th>Volatility</th><th>Depth</th><th>Volume</th></tr></thead><tbody>';

            for (const row of data) {
                const bandClass = row.band.includes('Excellent') ? 'text-success' :
                                  row.band.includes('High') ? 'text-primary' :
                                  row.band.includes('Medium') ? 'text-warning' : 'text-danger';
                html += `
                    <tr>
                        <td><span class="${bandClass}">${row.band}</span></td>
                        <td>${row.avg_spread_ticks.toFixed(2)} <small class="text-muted">(${row.min_spread.toFixed(1)}-${row.max_spread.toFixed(1)})</small></td>
                        <td>${row.avg_volatility.toFixed(4)}</td>
                        <td>${row.avg_depth.toLocaleString()}</td>
                        <td>${(row.avg_volume/1000).toFixed(0)}k <small class="text-muted">(${(row.min_volume/1000).toFixed(0)}k-${(row.max_volume/1000).toFixed(0)}k)</small></td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            document.getElementById('metrics-container').innerHTML = html;
        } catch (e) {
            document.getElementById('metrics-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load raw metrics</div>';
        }
    }

    // High Scoring Markets
    async function loadHighScores() {
        try {
            const response = await fetch('/api/analytics/high-scoring-markets?min_score=55&limit=20');
            const data = await response.json();

            document.getElementById('high-score-count').textContent = data.length + ' markets';

            if (data.length === 0) {
                document.getElementById('high-scores-container').innerHTML =
                    '<div class="text-center text-muted py-4">No markets scoring 55+ yet. Keep collecting data!</div>';
                return;
            }

            let html = '<table class="table table-sm table-hover mb-0"><thead><tr>' +
                '<th>Competition</th><th>Event</th><th>Market</th><th>Score</th><th>Components</th><th>Volume</th></tr></thead><tbody>';

            for (const row of data) {
                const scoreClass = row.total_score >= 70 ? 'bg-success' : 'bg-primary';
                const volume = row.total_matched_volume ? (row.total_matched_volume/1000).toFixed(0) + 'k' : '-';

                html += `
                    <tr>
                        <td><small>${row.competition}</small></td>
                        <td><small>${row.event}</small></td>
                        <td><strong>${row.market}</strong></td>
                        <td><span class="badge ${scoreClass}">${row.total_score.toFixed(1)}</span></td>
                        <td>
                            <small class="text-muted">
                                S:${row.spread_score.toFixed(0)}
                                V:${row.volatility_score.toFixed(0)}
                                D:${row.depth_score.toFixed(0)}
                                <span class="text-danger">-${row.volume_penalty.toFixed(0)}</span>
                            </small>
                        </td>
                        <td><small>${volume}</small></td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            document.getElementById('high-scores-container').innerHTML = html;
        } catch (e) {
            document.getElementById('high-scores-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load high scoring markets</div>';
        }
    }

    // Steamers Summary
    async function loadSteamersSummary() {
        try {
            const response = await fetch('/api/momentum/steamers?min_change=3&hours_ahead=24&limit=5');
            const data = await response.json();

            if (!response.ok || data.length === 0) {
                document.getElementById('steamers-summary-container').innerHTML =
                    '<div class="text-center text-muted py-4"><i class="bi bi-emoji-neutral"></i> No steamers detected</div>';
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            for (const s of data) {
                const change = s.change_2h || s.change_1h || s.change_30m || 0;
                const sharpBadge = s.movement_strength === 'SHARP' ? '<span class="badge bg-warning text-dark ms-1">SHARP</span>' : '';
                html += `
                    <div class="list-group-item bg-transparent border-secondary py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${s.runner_name}</strong>${sharpBadge}
                                <br><small class="text-muted">${s.competition_name} | ${s.market_type}</small>
                            </div>
                            <div class="text-end">
                                <span class="text-success fw-bold">${change.toFixed(1)}%</span>
                                <br><small class="text-muted">${s.current_back.toFixed(2)}</small>
                            </div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            document.getElementById('steamers-summary-container').innerHTML = html;
        } catch (e) {
            document.getElementById('steamers-summary-container').innerHTML =
                '<div class="text-center text-muted py-4">Failed to load steamers</div>';
        }
    }

    // Drifters Summary
    async function loadDriftersSummary() {
        try {
            const response = await fetch('/api/momentum/drifters?min_change=3&hours_ahead=24&limit=5');
            const data = await response.json();

            if (!response.ok || data.length === 0) {
                document.getElementById('drifters-summary-container').innerHTML =
                    '<div class="text-center text-muted py-4"><i class="bi bi-emoji-neutral"></i> No drifters detected</div>';
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            for (const d of data) {
                const change = d.change_2h || d.change_1h || d.change_30m || 0;
                const sharpBadge = d.movement_strength === 'SHARP' ? '<span class="badge bg-warning text-dark ms-1">SHARP</span>' : '';
                html += `
                    <div class="list-group-item bg-transparent border-secondary py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${d.runner_name}</strong>${sharpBadge}
                                <br><small class="text-muted">${d.competition_name} | ${d.market_type}</small>
                            </div>
                            <div class="text-end">
                                <span class="text-danger fw-bold">+${change.toFixed(1)}%</span>
                                <br><small class="text-muted">${d.current_back.toFixed(2)}</small>
                            </div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            document.getElementById('drifters-summary-container').innerHTML = html;
        } catch (e) {
            document.getElementById('drifters-summary-container').innerHTML =
                '<div class="text-center text-muted py-4">Failed to load drifters</div>';
        }
    }

    // Phase 2 Readiness
    async function loadPhase2Readiness() {
        try {
            const response = await fetch('/api/analytics/phase2-readiness');
            const data = await response.json();

            const badgeClass = data.ready_for_phase2 ? 'bg-success' :
                               data.overall_readiness_pct >= 50 ? 'bg-warning text-dark' : 'bg-secondary';
            const badgeText = data.ready_for_phase2 ? 'Ready!' :
                              `${data.overall_readiness_pct.toFixed(0)}% Complete`;
            document.getElementById('readiness-badge').className = `badge ${badgeClass}`;
            document.getElementById('readiness-badge').textContent = badgeText;

            const html = `
                <div class="row g-4">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Closing Data</span>
                                <span>${data.total_closing_data} / ${data.closing_data_target}</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" style="width: ${data.closing_data_pct}%">${data.closing_data_pct.toFixed(0)}%</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Settlement Results</span>
                                <span>${data.total_with_results} / ${data.results_target}</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: ${data.results_pct}%">${data.results_pct.toFixed(0)}%</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>High-Score Markets (30+)</span>
                                <span>${data.high_score_markets} / ${data.high_score_target}</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-warning" style="width: ${data.high_score_pct}%">${data.high_score_pct.toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="mb-2">
                            <div class="display-4 ${data.ready_for_phase2 ? 'text-success' : 'text-warning'}">${data.overall_readiness_pct.toFixed(0)}%</div>
                            <div class="text-muted">Overall Readiness</div>
                        </div>
                        <div class="small text-muted">
                            <div><i class="bi bi-calendar me-1"></i>${data.days_collecting} days collecting</div>
                            ${data.estimated_days_remaining ?
                                `<div><i class="bi bi-hourglass me-1"></i>~${data.estimated_days_remaining} days remaining</div>` : ''}
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-primary">${data.excellent_score_markets} excellent (55+)</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3 small text-muted border-top pt-2">
                    <i class="bi bi-info-circle me-1"></i>
                    Phase 2 (Shadow Trading) begins when we have enough data to validate the scoring model.
                    Target: 500+ closing data records, 200+ with settlement results, 50+ high-score markets.
                </div>
            `;
            document.getElementById('phase2-readiness-container').innerHTML = html;
        } catch (e) {
            document.getElementById('phase2-readiness-container').innerHTML =
                '<div class="alert alert-warning m-3">Phase 2 readiness data not yet available.</div>';
        }
    }

    // Niche Performance
    async function loadNichePerformance() {
        try {
            const response = await fetch('/api/analytics/niche-performance?min_markets=5&limit=15');
            const data = await response.json();

            if (data.length === 0) {
                document.getElementById('niche-container').innerHTML =
                    '<div class="text-center text-muted py-4">Not enough data yet. Need 5+ markets per niche.</div>';
                return;
            }

            let html = '<table class="table table-sm table-hover mb-0"><thead><tr>' +
                '<th>Niche</th><th>Markets</th><th>Avg Score</th><th>High (30+)</th><th>Consistency</th></tr></thead><tbody>';

            for (const row of data) {
                const scoreClass = row.avg_score >= 30 ? 'text-success' : row.avg_score >= 20 ? 'text-warning' : 'text-secondary';
                const consistencyClass = row.consistency_score >= 2 ? 'text-success' : row.consistency_score >= 1 ? 'text-warning' : 'text-secondary';

                html += `
                    <tr>
                        <td>
                            <div><strong>${row.competition}</strong></div>
                            <small class="text-muted">${row.market_type}</small>
                        </td>
                        <td>${row.total_markets}</td>
                        <td class="${scoreClass} fw-bold">${row.avg_score.toFixed(1)}</td>
                        <td><span class="badge bg-success">${row.high_score_count}</span></td>
                        <td class="${consistencyClass}">${row.consistency_score.toFixed(1)}</td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            html += '<div class="px-3 py-2 small text-muted bg-dark"><i class="bi bi-lightbulb me-1"></i>Higher consistency = more predictable scores. Focus on high avg + high consistency for Phase 2.</div>';
            document.getElementById('niche-container').innerHTML = html;
        } catch (e) {
            document.getElementById('niche-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load niche performance</div>';
        }
    }

    // CLV Analysis
    async function loadCLVAnalysis() {
        try {
            const response = await fetch('/api/analytics/clv-analysis');
            const data = await response.json();

            if (data.length === 0) {
                document.getElementById('clv-container').innerHTML =
                    '<div class="text-center text-muted py-4">No closing data with scores yet.</div>';
                return;
            }

            let html = '<table class="table table-sm mb-0"><thead><tr>' +
                '<th>Score Band</th><th>Markets</th><th>With CLV Data</th><th>Status</th></tr></thead><tbody>';

            for (const row of data) {
                const bandClass = row.score_band.includes('Excellent') ? 'text-success' :
                                  row.score_band.includes('High') ? 'text-primary' :
                                  row.score_band.includes('Medium') ? 'text-warning' : 'text-secondary';

                const clvStatus = row.with_clv_data > 0 ?
                    `<span class="badge bg-success">${row.with_clv_data} ready</span>` :
                    '<span class="badge bg-secondary">Waiting</span>';

                html += `
                    <tr>
                        <td class="${bandClass}">${row.score_band}</td>
                        <td>${row.market_count}</td>
                        <td>${row.with_clv_data}</td>
                        <td>${clvStatus}</td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            html += '<div class="px-3 py-2 small text-muted bg-dark"><i class="bi bi-graph-up me-1"></i>CLV = (Entry Price - Closing Price) / Closing Price. Positive CLV indicates edge.</div>';
            document.getElementById('clv-container').innerHTML = html;
        } catch (e) {
            document.getElementById('clv-container').innerHTML = '<div class="alert alert-danger m-3">Failed to load CLV analysis</div>';
        }
    }

    // Closing Data Summary
    async function loadClosingSummary() {
        try {
            const response = await fetch('/api/analytics/closing-data/summary');
            const data = await response.json();

            const html = `
                <div class="row g-3 text-center">
                    <div class="col-md-2">
                        <div class="stat-number text-info">${data.total_captured}</div>
                        <div class="stat-label">Total Captured</div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number text-primary">${data.with_closing_odds}</div>
                        <div class="stat-label">With Closing Odds</div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number text-warning">${data.with_final_score}</div>
                        <div class="stat-label">With Final Score</div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number text-success">${data.with_results}</div>
                        <div class="stat-label">With Results</div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number" style="color: #22c55e;">${data.high_score_captured}</div>
                        <div class="stat-label">High Score (55+)</div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number" style="color: #ffd700;">${data.excellent_score_captured}</div>
                        <div class="stat-label">Excellent (70+)</div>
                    </div>
                </div>
                <div class="mt-3 small text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Closing data is captured 5-15 minutes before event start. Results are captured after settlement.
                    This data enables backtesting and strategy validation.
                </div>
            `;
            document.getElementById('closing-summary-container').innerHTML = html;
        } catch (e) {
            document.getElementById('closing-summary-container').innerHTML =
                '<div class="alert alert-warning m-0"><i class="bi bi-clock me-2"></i>Closing data capture not yet active. Run the market_closure task to start collecting.</div>';
        }
    }

    // Closing Data Details
    async function loadClosingData() {
        try {
            const response = await fetch('/api/analytics/closing-data/high-scores?min_score=55&limit=20');
            const data = await response.json();

            document.getElementById('settled-count').textContent = data.length + ' markets';

            if (data.length === 0) {
                document.getElementById('closing-data-container').innerHTML =
                    '<div class="text-center text-muted py-4">No settled high-score markets yet. Data will appear after events finish.</div>';
                return;
            }

            let html = '<table class="table table-sm table-hover mb-0"><thead><tr>' +
                '<th>Competition</th><th>Event</th><th>Final Score</th><th>Closing Odds</th><th>Winner</th><th>Mins to Start</th></tr></thead><tbody>';

            for (const row of data) {
                const scoreClass = row.final_score >= 70 ? 'bg-success' : 'bg-primary';
                const closingOdds = row.closing_back_price ? `${row.closing_back_price.toFixed(2)} / ${row.closing_lay_price?.toFixed(2) || '-'}` : '-';
                const winner = row.winner || '<span class="text-muted">Pending</span>';
                const settled = row.settled_at ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-clock text-muted"></i>';

                html += `
                    <tr>
                        <td><small>${row.competition}</small></td>
                        <td><small>${row.event}</small></td>
                        <td><span class="badge ${scoreClass}">${row.final_score?.toFixed(1) || '-'}</span></td>
                        <td><small>${closingOdds}</small></td>
                        <td><small>${winner}</small> ${settled}</td>
                        <td><small>${row.minutes_to_start || '-'} min</small></td>
                    </tr>
                `;
            }
            html += '</tbody></table>';
            document.getElementById('closing-data-container').innerHTML = html;
        } catch (e) {
            document.getElementById('closing-data-container').innerHTML =
                '<div class="alert alert-warning m-3">Closing data not yet available. Start the market closure task to capture this data.</div>';
        }
    }
</script>
{% endblock %}
